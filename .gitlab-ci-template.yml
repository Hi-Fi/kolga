image: docker.anders.fi/anders/ci-runner-images/ci-runner:latest

stages:
  - build
  - test
  - review
  - staging
  - cleanup_review
  - stop_review

variables:
  CI_APPLICATION_REPOSITORY: "$CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG"
  DOCKER_IMAGE_TAG: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA"

  # Docker by default users `vfs` which is not suitable for
  # production use. overlay2 is the preferred driver by Docker.
  DOCKER_DRIVER: overlay2

  # If the host is not set docker cli will try to use a 172.x.x.x
  # IP when connecting to the Docker API, which will not work
  DOCKER_HOST: "tcp://localhost:2375"

  # Default usernames and passwords for postgres setups
  # Note: These are the credentials that will be used for testing
  POSTGRES_USER: user
  POSTGRES_PASSWORD: testing-password

  # Which version of Postgres that will be installed for testing
  # and for preview environments
  POSTGRES_VERSION_TAG: "9.6"

  # Default name for the Postgres database
  POSTGRES_DB: "$CI_ENVIRONMENT_SLUG"

  # Versions of Helm and Kubernetes CLI tools that should be installed
  # Note that these should correspond version that are compatible with
  # the version of the Kubernetes clusters
  HELM_VERSION: 2.12.3
  KUBERNETES_VERSION: 1.11.6

build:
  image: docker.anders.fi/anders/ci-runner-images/ci-runner-docker:latest
  services:
    - docker:stable-dind
  stage: build
  script:
    - build
  only:
    - branches

test:
  image: docker.anders.fi/anders/ci-runner-images/ci-runner-docker:latest
  services:
    - docker:stable-dind
  stage: test
  script:
    - test
  except:
    variables:
      - $TEST_DISABLED

review:
  stage: review
  script:
    - export
    - kube_auth qa
    - ensure_namespace
    - deploy
  environment:
    name: qa/r/${CI_COMMIT_REF_SLUG}
    url: http://$CI_PROJECT_PATH_SLUG-$CI_ENVIRONMENT_SLUG.$K8S_QA_INGRESS_DOMAIN
    on_stop: stop_review
  variables:
    POSTGRES_ENABLED: 1
  only:
    refs:
      - branches
    kubernetes: active
  except:
    refs:
      - master
    variables:
      - $REVIEW_DISABLED


cleanup_review:
  stage: cleanup_review
  script:
    - kube_auth qa
    - delete
  when: on_failure
  only:
    refs:
      - branches
    kubernetes: active
  except:
    refs:
      - master
    variables:
      - $REVIEW_DISABLED

stop_review:
  variables:
    git_strategy: none
  environment:
    name: qa/r/${CI_COMMIT_REF_SLUG}
    action: stop
  stage: stop_review
  script:
    - kube_auth qa
    - delete
  when: manual
  allow_failure: true
  only:
    refs:
      - branches
    kubernetes: active
  except:
    refs:
      - master
    variables:
      - $REVIEW_DISABLED

staging:
  stage: staging
  script:
    - kube_auth qa
    - ensure_namespace
    - deploy
  environment:
    name: qa/staging
    url: http://$CI_PROJECT_PATH_SLUG-qa.$K8S_QA_INGRESS_DOMAIN
  variables:
    POSTGRES_ENABLED: 1
  only:
    refs:
      - master
    kubernetes: active
    variables:
      - $STAGING_ENABLED

before_script:
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@git.anders.fi/".insteadOf "git@git.anders.fi:"
  - git clone --single-branch --branch v0 git@git.anders.fi:anders/ci-configuration.git /tmp/ci-configuration
  - source /tmp/ci-configuration/auto-devops.sh
